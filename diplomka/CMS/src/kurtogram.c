/*
 * kurtogram.c
 *
 *  Created on: 20. 3. 2018
 *      Author: matula
 */

#include "stm32l0xx.h"
#include "stm32l0xx_nucleo.h"
#include "hw.h"
#include "arm_math.h"
#include "vcom.h"
#include "math.h"
#include "kurtogram.h"
#include <inttypes.h>
#include <stdint.h>
#include <string.h>
#include <stdio.h>

#define nlevel 4
#define mocnina_dvou 16 		//2 na nlevel

float K[nlevel+1][mocnina_dvou];
int row_index_for_first_level = 0;


const float h_real[17] = {-0.001873, 0.002176, 0.000000, 0.000000, 0.040902, 0.031603, -0.000000, 0.206738, 0.400330, 0.206738, 0.000000, 0.031603, 0.040902, 0.000000, -0.000000, 0.002176, -0.001873};
const float h_imag[17] = { 0.000000, 0.002176, 0.010843, -0.000000, -0.000000, 0.031603, -0.081012, -0.206738, -0.000000, 0.206738, 0.081012, -0.031603, -0.000000, 0.000000, -0.010843, -0.002176, 0.000000};

const float g_real[16] = {-0.002176, -0.000000, -0.000000, 0.040902, -0.031603, 0.000000, -0.206738, 0.400330, -0.206738, -0.000000, -0.031603, 0.040902, -0.000000, 0.000000, -0.002176, -0.001873};
const float g_imag[16] = {0.002176, -0.010843, -0.000000, -0.000000, 0.031603, 0.081012, -0.206738, -0.000000, 0.206738, -0.081012, -0.031603, -0.000000, 0.000000, 0.010843, -0.002176, 0.000000};


void DBFB(uint32_t *res_real, uint32_t *res_imag, uint32_t *x_real, uint32_t *x_imag, const float *f_real, const float *f_imag, int size, int size_filter, int first, int neg);
void kurt_local(uint32_t *x_real, uint32_t *x_imag , int size, int level, int begin, int first);

const float testovaciDATA [] = {2054.000000, 2177.000000, 2110.000000, 2023.000000, 2014.000000, 2033.000000, 1925.000000, 2083.000000, 2102.000000, 2009.000000, 2114.000000, 2068.000000, 2025.000000, 2067.000000, 1979.000000, 2001.000000, 2077.000000, 2101.000000, 2169.000000, 1967.000000, 2096.000000, 1917.000000, 1838.000000, 2157.000000, 2008.000000, 2077.000000, 2206.000000, 1878.000000, 1968.000000, 2122.000000, 1994.000000, 2139.000000, 2249.000000, 1993.000000, 2011.000000, 1984.000000, 1881.000000, 2137.000000, 2128.000000, 2049.000000, 2021.000000, 2031.000000, 1955.000000, 2075.000000, 2227.000000, 2005.000000, 2171.000000, 2061.000000, 1909.000000, 2072.000000, 1920.000000, 2004.000000, 2133.000000, 1986.000000, 1981.000000, 2178.000000, 2000.000000, 1929.000000, 2146.000000, 1975.000000, 2121.000000, 2205.000000, 2005.000000, 2219.000000, 2025.000000, 1860.000000, 2001.000000, 2054.000000, 2085.000000, 2105.000000, 2055.000000, 2119.000000, 1767.000000, 1940.000000, 2190.000000, 1957.000000, 2508.000000, 1919.000000, 1911.000000, 2273.000000, 1643.000000, 1979.000000, 2319.000000, 1739.000000, 2133.000000, 2228.000000, 1711.000000, 2230.000000, 2171.000000, 1831.000000, 2252.000000, 2082.000000, 1895.000000, 2357.000000, 2061.000000, 1845.000000, 2173.000000, 1879.000000, 1899.000000, 2252.000000, 1969.000000, 2073.000000, 2266.000000, 1767.000000, 2055.000000, 2239.000000, 1868.000000, 2197.000000, 2135.000000, 1840.000000, 2083.000000, 2064.000000, 1860.000000, 2133.000000, 2092.000000, 1895.000000, 2181.000000, 2058.000000, 1997.000000, 2193.000000, 2026.000000, 1906.000000, 2113.000000, 2097.000000, 2021.000000, 2252.000000, 2027.000000, 1938.000000, 2085.000000, 1907.000000, 2000.000000, 2117.000000, 2036.000000, 1998.000000, 1981.000000, 2029.000000, 2005.000000, 2108.000000, 2059.000000, 2105.000000, 2211.000000, 1857.000000, 2135.000000, 1938.000000, 1913.000000, 2205.000000, 1881.000000, 2098.000000, 2203.000000, 1846.000000, 2125.000000, 2164.000000, 1815.000000, 2195.000000, 2243.000000, 1999.000000, 2209.000000, 2003.000000, 1841.000000, 2071.000000, 1961.000000, 1963.000000, 2256.000000, 2031.000000, 1894.000000, 2152.000000, 1974.000000, 2037.000000, 2221.000000, 1895.000000, 2244.000000, 2072.000000, 1757.000000, 2181.000000, 1959.000000, 1883.000000, 2205.000000, 2023.000000, 1955.000000, 2157.000000, 2049.000000, 2012.000000, 2124.000000, 1988.000000, 2126.000000, 2140.000000, 2002.000000, 2089.000000, 1938.000000, 1972.000000, 2007.000000, 2001.000000, 2123.000000, 2081.000000, 2103.000000, 2091.000000, 1652.000000, 2271.000000, 2139.000000, 1890.000000, 2479.000000, 1811.000000, 1870.000000, 2185.000000, 1707.000000, 2199.000000, 2180.000000, 1797.000000, 2212.000000, 2114.000000, 1809.000000, 2289.000000, 2031.000000, 1985.000000, 2237.000000, 1894.000000, 2035.000000, 2210.000000, 1941.000000, 2053.000000, 2097.000000, 1850.000000, 2041.000000, 2169.000000, 1913.000000, 2164.000000, 2151.000000, 1892.000000, 2066.000000, 2061.000000, 1977.000000, 2201.000000, 2026.000000, 1939.000000, 2078.000000, 1958.000000, 2012.000000, 2097.000000, 1991.000000, 2007.000000, 2109.000000, 2050.000000, 2029.000000, 2223.000000, 2003.000000, 1913.000000, 2201.000000, 2010.000000, 2046.000000, 2208.000000, 1987.000000, 1937.000000, 2041.000000, 1994.000000, 2002.000000, 2121.000000, 2150.000000, 2093.000000, 2000.000000, 1984.000000, 2041.000000, 2002.000000, 2180.000000, 2075.000000, 2005.000000, 2075.000000, 1907.000000, 1937.000000, 2102.000000, 1967.000000, 2180.000000, 2140.000000, 1887.000000, 2069.000000, 2053.000000, 2029.000000, 2178.000000, 2092.000000, 2101.000000, 2087.000000, 1925.000000, 1952.000000, 2021.000000, 2015.000000, 2094.000000, 2037.000000, 2038.000000, 2070.000000, 1959.000000, 2137.000000, 2023.000000, 2041.000000, 2278.000000, 1993.000000, 1978.000000, 1917.000000, 1833.000000, 2061.000000, 2114.000000, 2102.000000, 2167.000000, 2086.000000, 1885.000000, 2029.000000, 2045.000000, 2065.000000, 2265.000000, 2062.000000, 2097.000000, 2017.000000, 1835.000000, 2012.000000, 2053.000000, 2088.000000, 2203.000000, 2066.000000, 2218.000000, 1750.000000, 1877.000000, 2291.000000, 1857.000000, 2433.000000, 2114.000000, 1789.000000, 2213.000000, 1668.000000, 1837.000000, 2375.000000, 1860.000000, 2165.000000, 2345.000000, 1721.000000, 2049.000000, 2140.000000, 1827.000000, 2279.000000, 2162.000000, 1897.000000, 2229.000000, 2007.000000, 1847.000000, 2155.000000, 2036.000000, 1995.000000, 2180.000000, 1906.000000, 1947.000000, 2220.000000, 1942.000000, 2003.000000, 2244.000000, 1937.000000, 2039.000000, 2147.000000, 1905.000000, 2132.000000, 2105.000000, 1915.000000, 2045.000000, 2028.000000, 1999.000000, 2103.000000, 2093.000000, 2020.000000, 2032.000000, 2059.000000, 1994.000000, 2066.000000, 2223.000000, 2081.000000, 2037.000000, 2113.000000, 1923.000000, 2029.000000, 2053.000000, 2010.000000, 2116.000000, 2053.000000, 1971.000000, 1982.000000, 2070.000000, 2013.000000, 2039.000000, 2101.000000, 2108.000000, 2247.000000, 1947.000000, 1977.000000, 1962.000000, 1811.000000, 2118.000000, 2061.000000, 2077.000000, 2157.000000, 1916.000000, 1960.000000, 2123.000000, 1989.000000, 2197.000000, 2308.000000, 1957.000000, 2044.000000, 1955.000000, 1863.000000, 2152.000000, 2093.000000, 2028.000000, 2164.000000, 1959.000000, 1931.000000, 2141.000000, 2147.000000, 2015.000000, 2171.000000, 1997.000000, 2010.000000, 2091.000000, 1839.000000, 2070.000000, 2012.000000, 1913.000000, 2129.000000, 2126.000000, 2037.000000, 2075.000000, 2072.000000, 1949.000000, 2122.000000, 2051.000000, 2135.000000, 2191.000000, 1992.000000, 1989.000000, 1933.000000, 1995.000000, 2100.000000, 2075.000000, 2093.000000, 2007.000000, 1910.000000, 2083.000000, 1765.000000, 2233.000000, 2356.000000, 1658.000000, 2394.000000, 2018.000000, 1679.000000, 2354.000000, 1872.000000, 1933.000000, 2316.000000, 1769.000000, 2041.000000, 2328.000000, 1821.000000, 2139.000000, 2185.000000, 1807.000000, 2285.000000, 2189.000000, 1921.000000, 2193.000000, 1993.000000, 1831.000000, 2105.000000, 2032.000000, 1981.000000, 2198.000000, 1987.000000, 1896.000000, 2173.000000, 2045.000000, 2064.000000, 2175.000000, 2014.000000, 1955.000000, 2027.000000, 2009.000000, 1996.000000, 2101.000000, 2005.000000, 1970.000000, 2037.000000, 2000.000000, 2161.000000, 2157.000000, 2113.000000, 2027.000000, 2008.000000, 2000.000000, 1999.000000, 2185.000000, 1997.000000, 2021.000000, 2064.000000, 1890.000000, 2029.000000, 2063.000000, 1999.000000, 2061.000000, 2121.000000, 2084.000000, 2007.000000, 2095.000000, 1979.000000, 2125.000000, 2065.000000, 2021.000000, 2056.000000, 1967.000000, 2169.000000, 1917.000000, 1929.000000, 2223.000000, 1998.000000, 2024.000000, 2140.000000, 1925.000000, 2009.000000, 2213.000000, 1962.000000, 2141.000000, 2221.000000, 1904.000000, 2022.000000, 2014.000000, 1937.000000, 2122.000000, 2103.000000, 1932.000000, 2038.000000, 2080.000000, 1877.000000, 2209.000000, 2067.000000, 1948.000000, 2348.000000, 1909.000000, 1865.000000, 2154.000000, 1894.000000, 1975.000000, 2286.000000, 1944.000000, 2002.000000, 2160.000000, 1907.000000, 2064.000000, 2082.000000, 1964.000000, 2205.000000, 2061.000000, 2103.000000, 2106.000000, 1937.000000, 2015.000000, 1984.000000, 2035.000000, 2135.000000, 2111.000000, 2259.000000, 1895.000000, 1861.000000, 2231.000000, 1865.000000, 2396.000000, 2043.000000, 1939.000000, 2158.000000, 1643.000000, 2021.000000, 2204.000000, 1846.000000, 2163.000000, 2163.000000, 1787.000000, 2161.000000, 2115.000000, 1898.000000, 2323.000000, 2073.000000, 1899.000000, 2296.000000, 2030.000000, 1939.000000, 2191.000000, 1874.000000, 1878.000000, 2110.000000, 1885.000000, 2007.000000, 2275.000000, 1901.000000, 2011.000000, 2195.000000, 1977.000000, 2161.000000, 2238.000000, 1901.000000, 2007.000000, 2026.000000, 1857.000000, 2095.000000, 2123.000000, 1905.000000, 2125.000000, 2085.000000, 1949.000000, 2205.000000, 2135.000000, 1960.000000, 2223.000000, 2067.000000, 1907.000000, 2218.000000, 1961.000000, 1937.000000, 2101.000000, 1897.000000, 2018.000000, 2256.000000, 1956.000000, 2104.000000, 2132.000000, 1891.000000, 2077.000000, 2011.000000, 2057.000000, 2177.000000, 2056.000000, 2053.000000, 1969.000000, 1863.000000, 2020.000000, 2032.000000, 2049.000000, 2181.000000, 2021.000000, 2018.000000, 2054.000000, 2023.000000, 2039.000000, 2123.000000, 2073.000000, 2090.000000, 2072.000000, 1977.000000, 1990.000000, 2061.000000, 1995.000000, 2069.000000, 2085.000000, 2102.000000, 2094.000000, 2000.000000, 2027.000000, 2013.000000, 2008.000000, 2005.000000, 2238.000000, 2013.000000, 1925.000000, 2126.000000, 1860.000000, 1990.000000, 2141.000000, 2059.000000, 2077.000000, 2064.000000, 1973.000000, 2036.000000, 2135.000000, 2065.000000, 2139.000000, 2184.000000, 1959.000000, 1985.000000, 1994.000000, 1935.000000, 2152.000000, 2023.000000, 2055.000000, 2116.000000, 1812.000000, 2089.000000, 1949.000000, 2025.000000, 2441.000000, 1783.000000, 2237.000000, 2207.000000, 1633.000000, 2124.000000, 2074.000000, 1765.000000, 2276.000000, 2061.000000, 1865.000000, 2257.000000, 1978.000000, 1937.000000, 2273.000000, 2022.000000, 2086.000000, 2282.000000, 1931.000000, 1958.000000, 2105.000000, 1885.000000, 2009.000000, 2087.000000, 1945.000000, 2109.000000, 2123.000000, 1999.000000, 2139.000000, 2132.000000, 1947.000000, 2057.000000, 2062.000000, 1983.000000, 2069.000000, 2033.000000, 1971.000000, 1971.000000, 2028.000000, 2019.000000, 2092.000000, 2131.000000, 2035.000000, 2116.000000, 2024.000000, 1977.000000, 2087.000000, 2060.000000, 2135.000000, 2064.000000, 2052.000000, 1982.000000, 2041.000000, 2032.000000, 1987.000000, 2066.000000, 2009.000000, 1945.000000, 2101.000000, 2087.000000, 1992.000000, 2104.000000, 2032.000000, 2056.000000, 2211.000000, 1996.000000, 1979.000000, 2005.000000, 2025.000000, 2014.000000, 2018.000000, 2133.000000, 2077.000000, 1959.000000, 1988.000000, 2084.000000, 2049.000000, 2235.000000, 2162.000000, 2003.000000, 2099.000000, 1897.000000, 1927.000000, 2154.000000, 1971.000000, 2059.000000, 2079.000000, 1822.000000, 1987.000000, 2176.000000, 2053.000000, 2205.000000, 2085.000000, 1911.000000, 2253.000000, 1917.000000, 1955.000000, 2159.000000, 1865.000000, 2001.000000, 2129.000000, 1989.000000, 2045.000000, 2167.000000, 1929.000000, 2061.000000, 2013.000000, 1966.000000, 2309.000000, 2054.000000, 2051.000000, 2094.000000, 1837.000000, 2037.000000, 2089.000000, 2017.000000, 2198.000000, 2016.000000, 2060.000000, 1998.000000, 1704.000000, 2439.000000, 1978.000000, 2063.000000, 2458.000000, 1609.000000, 2049.000000, 2175.000000, 1661.000000, 2287.000000, 2069.000000, 1757.000000, 2338.000000, 1914.000000, 1837.000000, 2350.000000, 1941.000000, 2041.000000, 2377.000000, 1904.000000, 2090.000000, 2240.000000, 1736.000000, 1995.000000, 2155.000000, 1813.000000, 2129.000000, 2140.000000, 1732.000000, 2205.000000, 2120.000000, 1898.000000, 2313.000000, 2092.000000, 1999.000000, 2125.000000, 1947.000000, 1957.000000, 2089.000000, 2009.000000, 1930.000000, 2079.000000, 1925.000000, 2019.000000, 2256.000000, 2071.000000, 2091.000000, 2146.000000, 1952.000000, 1992.000000, 2210.000000, 2112.000000, 1985.000000, 2097.000000, 1909.000000, 1889.000000, 2108.000000, 2075.000000, 2132.000000, 2111.000000, 2031.000000, 1985.000000, 2053.000000, 2009.000000, 2021.000000, 2151.000000, 2033.000000, 2135.000000, 1969.000000, 2017.000000, 2000.000000, 1873.000000, 2072.000000, 2045.000000, 2045.000000, 2169.000000, 1993.000000, 1989.000000, 2065.000000, 2000.000000, 2052.000000, 2193.000000, 2117.000000, 2041.000000, 2050.000000, 1922.000000, 1975.000000, 2095.000000, 2065.000000, 2048.000000, 2155.000000, 1979.000000, 2018.000000, 2173.000000, 1927.000000, 2134.000000, 2153.000000, 1947.000000, 2043.000000, 1965.000000, 2008.000000, 2075.000000, 2021.000000, 2009.000000, 2101.000000, 2057.000000, 1996.000000, 2133.000000, 2009.000000, 2061.000000, 2139.000000, 1999.000000, 2225.000000, 1933.000000, 2023.000000, 1988.000000, 2026.000000, 2083.000000, 2081.000000, 2183.000000, 1777.000000, 1996.000000, 2111.000000, 1894.000000, 2529.000000, 1853.000000, 2034.000000, 2257.000000, 1571.000000, 2064.000000, 2277.000000, 2186.000000, 2120.000000, 1771.000000, 2242.000000, 2099.000000, 1969.000000, 2260.000000, 1993.000000, 1930.000000, 2183.000000, 1979.000000, 2031.000000, 2187.000000, 1881.000000, 1963.000000, 2095.000000, 1944.000000, 2171.000000, 2238.000000, 1961.000000, 2076.000000, 2085.000000, 1917.000000, 2099.000000, 2101.000000, 1938.000000, 2069.000000, 2079.000000, 1915.000000, 2068.000000, 2081.000000, 1900.000000, 2140.000000, 2019.000000, 2050.000000, 2170.000000, 2052.000000, 1981.000000, 2039.000000, 2069.000000, 2041.000000, 2181.000000, 2056.000000, 2018.000000, 2077.000000, 1939.000000, 1973.000000, 2103.000000, 2009.000000, 2018.000000, 2121.000000, 1973.000000, 1994.000000, 2091.000000, 2016.000000, 2165.000000, 2192.000000, 1955.000000, 2049.000000, 1991.000000, 1876.000000, 2097.000000, 2001.000000, 2035.000000, 2183.000000, 1915.000000, 2050.000000, 2165.000000, 1941.000000, 2159.000000, 2201.000000, 1981.000000, 2126.000000, 2081.000000, 1879.000000, 2083.000000, 2009.000000, 1866.000000, 2183.000000, 2062.000000, 1933.000000, 2218.000000, 1989.000000, 2026.000000, 2143.000000, 1891.000000, 2256.000000, 2052.000000, 1853.000000, 2124.000000, 1855.000000, 1925.000000, 2169.000000, 2061.000000, 2076.000000, 2120.000000, 1947.000000, 2017.000000, 2111.000000, 2001.000000, 2226.000000, 2121.000000, 1988.000000, 2115.000000, 1885.000000, 2032.000000, 2093.000000, 1939.000000, 2149.000000, 2026.000000, 1996.000000, 2169.000000, 1719.000000, 2259.000000, 2203.000000, 1807.000000, 2503.000000, 1858.000000, 1805.000000, 2298.000000, 1687.000000, 2008.000000, 2315.000000, 1783.000000, 2159.000000, 2195.000000, 1709.000000, 2279.000000, 2084.000000, 1956.000000, 2364.000000, 2027.000000, 1972.000000, 2222.000000, 1855.000000, 1972.000000, 2189.000000, 1823.000000, 2031.000000, 2135.000000, 1852.000000, 2199.000000, 2196.000000, 1911.000000, 2107.000000, 2029.000000, 1929.000000, 2181.000000, 2053.000000, 1971.000000, 2074.000000, 1872.000000, 1953.000000, 2085.000000, 2067.000000, 2183.000000, 2183.000000, 2039.000000, 2002.000000, 1987.000000, 2067.000000, 1993.000000, 2137.000000, 2180.000000, 1927.000000, 2067.000000, 2009.000000, 1917.000000, 2116.000000, 2108.000000, 2029.000000, 2128.000000, 2100.000000, 1968.000000, 2039.000000, 1995.000000, 1896.000000, 2201.000000, 2087.000000, 2155.000000, 2052.000000, 1875.000000, 2081.000000, 1928.000000, 2003.000000, 2208.000000, 2020.000000, 2057.000000, 2012.000000, 1872.000000, 2061.000000, 2186.000000, 2036.000000, 1897.000000, 2149.000000, 2051.000000, 1891.000000, 2213.000000, 2028.000000, 1929.000000, 2201.000000, 2035.000000, 2021.000000, 2189.000000, 1941.000000, 2020.000000, 2087.000000, 1882.000000, 2003.000000, 2105.000000, 2027.000000, 2141.000000, 2074.000000, 1977.000000, 2015.000000, 2071.000000, 2065.000000, 2077.000000, 2243.000000, 2067.000000, 1964.000000, 2033.000000, 1948.000000, 2037.000000, 2130.000000, 2053.000000, 2035.000000, 2068.000000, 1926.000000, 1945.000000, 2127.000000, 2043.000000, 2071.000000, 2149.000000, 1959.000000, 2241.000000, 1985.000000, 1897.000000, 2091.000000, 1865.000000, 2051.000000, 2117.000000, 2033.000000, 2075.000000, 2030.000000, 1905.000000, 2119.000000, 2124.000000, 2064.000000, 2300.000000, 2043.000000, 1913.000000, 2021.000000, 1887.000000, 2031.000000, 2185.000000, 1990.000000, 2085.000000, 2125.000000, 1868.000000, 2081.000000, 2220.000000, 1962.000000, 2147.000000, 2023.000000, 2038.000000, 2059.000000, 1865.000000, 2091.000000, 1987.000000, 1951.000000, 2129.000000, 2081.000000, 2081.000000, 2017.000000, 2058.000000, 2013.000000, 2085.000000, 2084.000000, 2215.000000, 2135.000000, 1956.000000, 2044.000000, 1835.000000, 2033.000000, 2139.000000, 1976.000000, 2193.000000, 2001.000000, 1821.000000, 2140.000000, 1760.000000, 2235.000000, 2530.000000, 1653.000000, 2362.000000, 2059.000000, 1527.000000, 2382.000000, 1929.000000, 1872.000000, 2419.000000, 1757.000000, 1925.000000, 2352.000000, 1765.000000, 2119.000000, 2341.000000, 1847.000000, 2209.000000, 2235.000000, 1817.000000, 2207.000000, 2001.000000, 1744.000000, 2215.000000, 1956.000000, 1916.000000, 2338.000000, 1891.000000, 1959.000000, 2281.000000, 1861.000000, 2119.000000, 2223.000000, 1958.000000, 2090.000000, 2036.000000, 1929.000000, 1989.000000, 2070.000000, 1983.000000, 2022.000000, 2079.000000, 2003.000000, 2162.000000, 2114.000000, 2009.000000, 2063.000000, 2127.000000, 1971.000000, 2075.000000, 2201.000000, 1895.000000, 2041.000000, 2061.000000, 1889.000000, 2095.000000, 2148.000000, 1969.000000, 2029.000000, 2139.000000, 1970.000000, 2081.000000, 2093.000000, 1991.000000, 2155.000000, 2045.000000, 1981.000000, 2039.000000, 2148.000000, 1988.000000, 1991.000000, 2053.000000, 1893.000000, 2080.000000, 2070.000000, 2005.000000, 2153.000000, 1985.000000, 2006.000000, 2069.000000, 2063.000000, 2120.000000, 2130.000000, 1972.000000, 1972.000000, 2027.000000, 2040.000000, 2033.000000, 2119.000000, 2041.000000, 1965.000000, 2138.000000, 1938.000000, 2028.000000, 2293.000000, 1911.000000, 2080.000000, 2053.000000, 1898.000000, 2100.000000, 2088.000000, 1969.000000, 2123.000000, 2068.000000, 1943.000000, 2089.000000, 2054.000000, 2049.000000, 2129.000000, 2099.000000, 2150.000000, 2068.000000, 1970.000000, 1999.000000, 1963.000000, 2065.000000, 2080.000000, 2059.000000, 2267.000000, 1756.000000, 2019.000000, 2090.000000, 1925.000000, 2507.000000, 1822.000000, 2067.000000, 2237.000000, 1524.000000, 2119.000000, 2223.000000, 1772.000000, 2275.000000, 2127.000000, 1738.000000, 2250.000000, 2094.000000, 1865.000000, 2337.000000, 1985.000000, 1883.000000, 2253.000000, 1965.000000, 1977.000000, 2233.000000, 1899.000000, 1926.000000, 2154.000000, 1921.000000, 2129.000000, 2285.000000, 1877.000000, 2073.000000, 2115.000000, 1877.000000, 2183.000000, 2132.000000, 1906.000000, 2115.000000, 1996.000000, 1874.000000, 2138.000000, 2053.000000, 1962.000000, 2152.000000, 2028.000000, 1985.000000, 2149.000000, 2075.000000, 1943.000000, 2119.000000, 2116.000000, 1987.000000, 2199.000000, 2065.000000, 1888.000000, 2117.000000, 1949.000000, 1960.000000, 2148.000000, 2057.000000, 1960.000000, 2077.000000, 1997.000000, 1947.000000, 2177.000000, 2044.000000, 2084.000000, 2301.000000, 1921.000000, 1937.000000, 2058.000000, 1821.000000, 2065.000000, 2141.000000, 2017.000000, 2152.000000, 1975.000000, 1936.000000, 2117.000000, 2017.000000, 2121.000000, 2263.000000, 2078.000000, 2039.000000, 1993.000000, 1875.000000, 2025.000000, 2054.000000, 1995.000000, 2146.000000, 2087.000000, 1925.000000, 2101.000000, 2031.000000, 2055.000000, 2117.000000, 1996.000000, 2212.000000, 1959.000000, 1892.000000, 2059.000000, 1831.000000, 2081.000000, 2142.000000, 2006.000000, 2119.000000, 2065.000000, 1952.000000, 2074.000000, 2061.000000, 2025.000000, 2245.000000, 2031.000000, 2025.000000, 2087.000000, 1916.000000, 2107.000000, 1966.000000, 2103.000000, 2082.000000, 2080.000000, 2116.000000, 1746.000000, 2325.000000, 2066.000000, 1845.000000, 2467.000000, 2033.000000, 1903.000000, 2083.000000, 2057.000000, 2076.000000, 2086.000000, 1999.000000, 2172.000000, 1921.000000, 1974.000000, 2041.000000, 1877.000000, 2087.000000, 2103.000000, 2064.000000, 2155.000000, 2074.000000, 1922.000000, 2030.000000, 1975.000000, 2029.000000, 2280.000000, 2103.000000, 2045.000000, 2081.000000, 1817.000000, 2037.000000, 2114.000000, 2053.000000, 2200.000000, 2062.000000, 2019.000000, 2025.000000, 1709.000000, 2305.000000, 2187.000000, 1806.000000, 2513.000000, 1785.000000, 1775.000000, 2365.000000, 1753.000000, 2001.000000, 2305.000000, 1767.000000, 2129.000000, 2241.000000, 1780.000000, 2179.000000, 2171.000000, 1843.000000, 2279.000000, 2154.000000, 1950.000000, 2293.000000, 1894.000000, 1807.000000, 2148.000000, 1913.000000, 2027.000000, 2161.000000, 1893.000000, 2090.000000, 2083.000000, 1924.000000, 2154.000000, 2141.000000, 2076.000000, 2149.000000, 1936.000000, 1952.000000, 2037.000000, 1959.000000, 2050.000000, 2056.000000, 1971.000000, 2147.000000, 2103.000000, 2014.000000, 2118.000000, 2033.000000, 2039.000000, 2085.000000, 2104.000000, 2197.000000, 1981.000000, 1991.000000, 1977.000000, 1893.000000, 2101.000000, 2141.000000, 2056.000000, 2125.000000, 2023.000000, 1858.000000, 2096.000000, 2101.000000, 2000.000000, 2203.000000, 1997.000000, 2041.000000, 2100.000000, 1853.000000, 2045.000000, 2055.000000, 1905.000000, 2127.000000, 2108.000000, 1989.000000, 2117.000000, 1994.000000, 1993.000000, 2135.000000, 2014.000000, 2177.000000, 2166.000000, 1983.000000, 2004.000000, 1923.000000, 2007.000000, 2061.000000, 2096.000000, 2038.000000, 2087.000000, 1978.000000, 1973.000000, 2203.000000, 2011.000000, 2153.000000, 2065.000000, 2007.000000, 2051.000000, 1808.000000, 2127.000000, 2091.000000, 1949.000000, 2144.000000, 2024.000000, 1975.000000, 2068.000000, 2089.000000, 2036.000000, 2180.000000, 2028.000000, 2033.000000, 2165.000000, 1947.000000, 1997.000000, 2064.000000, 1973.000000, 2098.000000, 2073.000000, 2020.000000, 2062.000000, 1849.000000, 2060.000000, 1898.000000, 2131.000000, 2411.000000, 1745.000000, 2265.000000, 2095.000000, 1641.000000, 2311.000000, 2031.000000, 1904.000000, 2295.000000, 1827.000000, 1937.000000, 2247.000000, 1884.000000, 2120.000000, 2241.000000, 1848.000000, 2150.000000, 2181.000000, 1910.000000, 2241.000000, 2045.000000, 1865.000000, 2112.000000, 1898.000000, 1921.000000, 2306.000000, 2043.000000, 1975.000000, 2236.000000, 1911.000000, 1965.000000, 2190.000000, 1993.000000, 2056.000000, 2185.000000, 1879.000000, 1933.000000, 2079.000000, 1957.000000, 2084.000000, 2050.000000, 2029.000000, 2101.000000, 2095.000000, 2097.000000, 2019.000000, 2089.000000, 2006.000000, 2019.000000, 2176.000000, 2023.000000, 2037.000000, 2090.000000, 1909.000000, 1989.000000, 2066.000000, 2013.000000, 2043.000000, 2176.000000, 2044.000000, 1937.000000, 2112.000000, 2034.000000, 2072.000000, 2161.000000, 1978.000000, 2010.000000, 2040.000000, 1952.000000, 2105.000000, 2021.000000, 2043.000000, 2151.000000, 1938.000000, 1975.000000, 2102.000000, 1982.000000, 2141.000000, 2150.000000, 2006.000000, 2114.000000, 2029.000000, 1930.000000, 2059.000000, 2017.000000, 2001.000000, 2151.000000, 1969.000000, 1989.000000, 2125.000000, 1965.000000, 2125.000000, 2023.000000, 2023.000000, 2267.000000, 1957.000000, 1916.000000, 2037.000000, 1895.000000, 2042.000000, 2187.000000, 2020.000000, 2079.000000, 2113.000000, 1895.000000, 2075.000000, 2095.000000, 1980.000000, 2218.000000, 2019.000000, 2099.000000, 1955.000000, 2065.000000, 2077.000000, 1974.000000, 2091.000000, 2112.000000, 2181.000000, 1929.000000, 1797.000000, 2428.000000, 1793.000000, 2158.000000, 2360.000000, 1709.000000, 2179.000000, 2054.000000, 1652.000000, 2239.000000, 2033.000000, 1789.000000, 2381.000000, 2019.000000, 1805.000000, 2347.000000, 1947.000000, 1958.000000, 2368.000000, 1893.000000, 2069.000000, 2254.000000, 1815.000000, 2034.000000, 2111.000000, 1870.000000, 2027.000000, 2048.000000, 1947.000000, 2227.000000, 2088.000000, 1922.000000, 2127.000000, 1993.000000, 2012.000000, 2225.000000, 2051.000000, 2067.000000, 2094.000000, 1848.000000, 1920.000000, 2052.000000, 1983.000000, 2174.000000, 2107.000000, 2045.000000, 2035.000000, 2005.000000, 2093.000000, 2067.000000, 2155.000000, 2137.000000, 2076.000000, 2022.000000, 1973.000000, 1930.000000, 1996.000000, 2064.000000, 2002.000000, 2131.000000, 2097.000000, 1989.000000, 2088.000000, 1993.000000, 1921.000000, 2109.000000, 2137.000000, 2145.000000, 2109.000000, 1975.000000, 1816.000000, 1907.000000, 1987.000000, 2101.000000, 2233.000000, 2151.000000, 2030.000000, 1969.000000, 1956.000000, 2007.000000, 2186.000000, 2225.000000, 2096.000000, 2031.000000, 1944.000000, 1865.000000, 2063.000000, 2076.000000, 2055.000000, 2193.000000, 2087.000000, 1939.000000, 2105.000000, 1976.000000, 2011.000000, 2119.000000, 1920.000000, 2250.000000, 2055.000000, 1839.000000, 2149.000000, 1853.000000, 1922.000000, 2212.000000, 2084.000000, 2121.000000, 2065.000000, 1916.000000, 1942.000000, 2104.000000, 2053.000000, 2261.000000, 2192.000000, 1962.000000, 2031.000000, 1853.000000, 2035.000000, 2135.000000, 2033.000000, 2197.000000, 1970.000000, 1869.000000, 2120.000000, 1649.000000, 2330.000000, 2335.000000, 1767.000000, 2527.000000, 1877.000000, 1639.000000, 2333.000000, 1775.000000, 1970.000000, 2341.000000, 1735.000000, 2137.000000, 2229.000000, 1702.000000, 2217.000000, 2171.000000, 1917.000000, 2336.000000, 2191.000000, 1901.000000, 2189.000000, 1889.000000, 1850.000000, 2149.000000, 1956.000000, 2031.000000, 2161.000000, 1928.000000, 1998.000000, 2165.000000, 2011.000000, 2115.000000, 2201.000000, 2010.000000, 2039.000000, 1983.000000, 1924.000000, 1973.000000, 1982.000000, 2056.000000, 2050.000000, 2037.000000, 2105.000000, 2139.000000, 2070.000000, 2070.000000, 2064.000000, 2092.000000, 1985.000000, 2097.000000, 2136.000000, 1870.000000, 2018.000000, 2029.000000, 1985.000000, 2155.000000, 2109.000000, 2045.000000, 2029.000000, 2052.000000, 2012.000000, 2057.000000, 2081.000000, 2023.000000, 2129.000000, 1949.000000, 2001.000000, 2113.000000, 1907.000000, 2165.000000, 2010.000000, 1940.000000, 2233.000000, 1965.000000, 1979.000000, 2125.000000, 1886.000000, 2031.000000, 2187.000000, 1948.000000, 2202.000000, 2113.000000, 1864.000000, 2121.000000, 1982.000000, 2005.000000, 2214.000000, 2054.000000, 1941.000000, 2042.000000, 1959.000000, 1981.000000, 2257.000000, 1959.000000, 2163.000000, 2231.000000, 1819.000000, 2110.000000, 1943.000000, 1961.000000, 2193.000000, 1995.000000, 2021.000000, 2111.000000, 1965.000000, 1973.000000, 2097.000000, 2015.000000, 2146.000000, 2167.000000, 2057.000000, 2157.000000, 1985.000000, 1920.000000, 2019.000000, 2017.000000, 2095.000000, 2067.000000, 2043.000000, 2163.000000, 1771.000000, 2036.000000, 1980.000000, 2164.000000, 2435.000000, 1734.000000, 2195.000000, 2114.000000, 1603.000000, 2247.000000, 2044.000000, 1847.000000, 2283.000000, 1883.000000, 1915.000000, 2315.000000, 1916.000000, 2081.000000, 2247.000000, 1833.000000, 2129.000000, 2262.000000, 1877.000000, 2169.000000, 2077.000000, 1817.000000, 2071.000000, 2017.000000, 1934.000000, 2210.000000, 2146.000000, 1900.000000, 2103.000000, 2102.000000, 1973.000000, 2176.000000, 1943.000000, 2060.000000, 1975.000000, 2071.000000, 2044.000000, 1920.000000, 2055.000000, 2093.000000, 2025.000000, 2154.000000, 2125.000000, 1933.000000, 2093.000000};

uint32_t *flash_start[] = {FLASH_BASE + FLASH_PAGE_SIZE * 1040, FLASH_BASE + FLASH_PAGE_SIZE * 1072, FLASH_BASE + FLASH_PAGE_SIZE * 1104, FLASH_BASE + FLASH_PAGE_SIZE * 1136,//1
						   FLASH_BASE + FLASH_PAGE_SIZE * 1168, FLASH_BASE + FLASH_PAGE_SIZE * 1184, FLASH_BASE + FLASH_PAGE_SIZE * 1200, FLASH_BASE + FLASH_PAGE_SIZE * 1216,//2
						   FLASH_BASE + FLASH_PAGE_SIZE * 1232, FLASH_BASE + FLASH_PAGE_SIZE * 1248, FLASH_BASE + FLASH_PAGE_SIZE * 1264, FLASH_BASE + FLASH_PAGE_SIZE * 1280,
						   FLASH_BASE + FLASH_PAGE_SIZE * 1296, FLASH_BASE + FLASH_PAGE_SIZE * 1304, FLASH_BASE + FLASH_PAGE_SIZE * 1312, FLASH_BASE + FLASH_PAGE_SIZE * 1320, //3
						   FLASH_BASE + FLASH_PAGE_SIZE * 1328, FLASH_BASE + FLASH_PAGE_SIZE * 1336, FLASH_BASE + FLASH_PAGE_SIZE * 1344, FLASH_BASE + FLASH_PAGE_SIZE * 1352,
						   FLASH_BASE + FLASH_PAGE_SIZE * 1360, FLASH_BASE + FLASH_PAGE_SIZE * 1368, FLASH_BASE + FLASH_PAGE_SIZE * 1376, FLASH_BASE + FLASH_PAGE_SIZE * 1384,
						   FLASH_BASE + FLASH_PAGE_SIZE * 1392, FLASH_BASE + FLASH_PAGE_SIZE * 1400, FLASH_BASE + FLASH_PAGE_SIZE * 1408, FLASH_BASE + FLASH_PAGE_SIZE * 1416,
						   FLASH_BASE + FLASH_PAGE_SIZE * 1424, FLASH_BASE + FLASH_PAGE_SIZE * 1428, FLASH_BASE + FLASH_PAGE_SIZE * 1432, FLASH_BASE + FLASH_PAGE_SIZE * 1436, //4
						   FLASH_BASE + FLASH_PAGE_SIZE * 1440, FLASH_BASE + FLASH_PAGE_SIZE * 1444, FLASH_BASE + FLASH_PAGE_SIZE * 1448, FLASH_BASE + FLASH_PAGE_SIZE * 1452,
						   FLASH_BASE + FLASH_PAGE_SIZE * 1456, FLASH_BASE + FLASH_PAGE_SIZE * 1460, FLASH_BASE + FLASH_PAGE_SIZE * 1464, FLASH_BASE + FLASH_PAGE_SIZE * 1468,
						   FLASH_BASE + FLASH_PAGE_SIZE * 1472, FLASH_BASE + FLASH_PAGE_SIZE * 1476, FLASH_BASE + FLASH_PAGE_SIZE * 1480, FLASH_BASE + FLASH_PAGE_SIZE * 1484,
						   FLASH_BASE + FLASH_PAGE_SIZE * 1488, FLASH_BASE + FLASH_PAGE_SIZE * 1492, FLASH_BASE + FLASH_PAGE_SIZE * 1496, FLASH_BASE + FLASH_PAGE_SIZE * 1500,
						   FLASH_BASE + FLASH_PAGE_SIZE * 1504, FLASH_BASE + FLASH_PAGE_SIZE * 1508, FLASH_BASE + FLASH_PAGE_SIZE * 1512, FLASH_BASE + FLASH_PAGE_SIZE * 1516,
						   FLASH_BASE + FLASH_PAGE_SIZE * 1520, FLASH_BASE + FLASH_PAGE_SIZE * 1524, FLASH_BASE + FLASH_PAGE_SIZE * 1528, FLASH_BASE + FLASH_PAGE_SIZE * 1532,
						   FLASH_BASE + FLASH_PAGE_SIZE * 1040, FLASH_BASE + FLASH_PAGE_SIZE * 1044, FLASH_BASE + FLASH_PAGE_SIZE * 1048, FLASH_BASE + FLASH_PAGE_SIZE * 1052};







/*
uint32_t Address = 0, PAGEError = 0;
__IO uint32_t data32 = 0, MemoryProgramStatus = 0;

static FLASH_EraseInitTypeDef EraseInitStruct;

#define FLASH_USER_START_ADDR   (FLASH_BASE + FLASH_PAGE_SIZE * 1024)
#define FLASH_USER_END_ADDR     (FLASH_USER_START_ADDR + FLASH_PAGE_SIZE)

float x = -88.123456 ;
uint32_t y;*/

uint32_t FloatToUint(float n)
{
   return (uint32_t)(*(uint32_t*)&n);
}

float UintToFloat(uint32_t n)
{
   return (float)(*(float*)&n);
}
/*
void flash_test()
{
	HAL_FLASH_Unlock();

	EraseInitStruct.TypeErase   = FLASH_TYPEERASE_PAGES;
	EraseInitStruct.PageAddress = FLASH_USER_START_ADDR;
	EraseInitStruct.NbPages     = (FLASH_USER_END_ADDR - FLASH_USER_START_ADDR) / FLASH_PAGE_SIZE;

	if (HAL_FLASHEx_Erase(&EraseInitStruct, &PAGEError) != HAL_OK)
	{
		PRINTF("flash error\n\r");
	}
	Address = FLASH_USER_START_ADDR;

	y = FloatToUint(x);
	while (Address < FLASH_USER_END_ADDR)
	{
		if (HAL_FLASH_Program(FLASH_TYPEPROGRAM_WORD, Address, y) == HAL_OK)
	    {
			Address = Address + 4;
	    }
		else
		{
			PRINTF("flash error\n\r");
		}
	}

	HAL_FLASH_Lock();

	uint32_t *p = FLASH_USER_START_ADDR;
	//PRINTF("pointer: %" PRIu32 "\n\r", p[0]);
	float p_float = UintToFloat(p[0]);
	PRINTF("pointer: %.6f \n\r", p_float);

	PRINTF("pointer: %" PRIu32 "\n\r", p[0]);
	PRINTF("pointer: %" PRIu32 "\n\r", p[1]);
	PRINTF("pointer: %" PRIu32 "\n\r", p[2]);*
	Address = FLASH_USER_START_ADDR;

	while (Address < FLASH_USER_END_ADDR)
	{
		data32 = *(__IO uint32_t *)Address;

		if (data32 != DATA_32)
		{
		   MemoryProgramStatus++;
		}
	    Address = Address + 4;
	}

	if (MemoryProgramStatus == 0)
	{
		PRINTF("No Error detected\n\r");
	}
	else
	{
		PRINTF("flash error\n\r");
	}


}*/
void testData()
{
	int i =0;

	while( i<sizeOfArray )
	{
		samples.test[i] = testovaciDATA[i];
		i++;
	}

}


float mean(uint32_t *x, int size)
{
	float result = 0;
	float value;
	for (int i=0; i < size; i++) {
		value = UintToFloat(x[i]);
		result += value;
	}
	return result/size;
}

void kurtogram()
{
	PRINTF("kurtogram\n\r");
	row_index_for_first_level = 0;

	for(int i=0;i<nlevel+1;i++)
	{
		for(int j=0;j<mocnina_dvou;j++)
		{
			K[i][j] = 0;
		}
	}

	//flash_test();
	testData();
	uint32_t *samples_imag = 0;

	for (int i=sizeOfArray-1; i >= 0; i--) {
		samples.data[i] = FloatToUint(samples.test[i]);//(uint32_t)(samples.adc_values[i]);
	}

	float m = mean(samples.data, sizeOfArray);

	//odecteni prumeru
	for (int i = 0; i < sizeOfArray; i++) {
		samples.data[i] = FloatToUint(UintToFloat(samples.data[i]) - m);
	}


	//K_wpq_local
	kurt_local(samples.data, samples_imag, sizeOfArray, nlevel, 0, 1);




	for(int i=0;i<nlevel+1;i++)
	{
		for(int j=0;j<mocnina_dvou;j++)
		{
			PRINTF("%.6f ", K[i][j]);
		}
		PRINTF("\n\r");
	}

}


int emptyArray(uint32_t *x, int size)
{
	for(int i=0;i<size;i++)
	{
		if(x[i] != 0)
		{
			return 0;
		}
	}
	return 1;
}


float kurtosis(uint32_t *x_real, uint32_t *x_imag, int size, int first)
{
	float kurtosis_value = 0;
	float x_imag_temp;
	float x_real_temp;

	if(first == 0)
	{
		if(emptyArray(x_real, size) == 1 &&  emptyArray(x_imag, size) == 1)
		{
			return 0;
		}
	}
	float mean_real = mean(x_real, size);
	float mean_imag = 0;

	if(first == 0)
	{
		mean_imag = mean(x_imag, size);
	}


	float E = 0;
	for (int i = 0; i < size; i++)
	{
		if(first)
		{
			x_imag_temp = 0;
		}
		else
		{
			x_imag_temp = UintToFloat(x_imag[i]) - mean_imag;
		}
		x_real_temp = UintToFloat(x_real[i]) - mean_real;
		E += (x_real_temp*x_real_temp ) + (x_imag_temp*x_imag_temp );
	}
	E = E/size;
	//printf("E = %f\n", E);
	if (E < 0.00000001)
	{
		return 0;
	}

	for (int i = 0; i < size; i++)
	{
		if(first)
		{
			x_imag_temp = 0;
		}
		else
		{
			x_imag_temp = UintToFloat(x_imag[i]) - mean_imag;
		}
		x_real_temp = UintToFloat(x_real[i]) - mean_real;
		kurtosis_value += ((x_real_temp*x_real_temp ) + (x_imag_temp*x_imag_temp )) * ((x_real_temp*x_real_temp ) + (x_imag_temp*x_imag_temp ));
	}

	kurtosis_value = (kurtosis_value/size)/(E*E);
	//printf("K = %f\n", kurtosis_value);

	if (first == 1 || emptyArray(x_imag, size) == 1)
	{
		kurtosis_value = kurtosis_value - 3;
	}
	else
	{
		kurtosis_value = kurtosis_value - 2;
	}
	return kurtosis_value;
}



void kurt_local(uint32_t *x_real, uint32_t *x_imag , int size, int level, int begin, int first)
{
	uint32_t *a_real;
	uint32_t *a_imag;

	uint32_t *d_real;
	uint32_t *d_imag;


	if(first==1)
	{
		a_real = flash_start[0];
		a_imag = flash_start[1];
		d_real = flash_start[2];
		d_imag = flash_start[3];
	}
	else if(level == nlevel - 1)
	{
		a_real = flash_start[4+begin/2];
		a_imag = flash_start[5+begin/2];
		d_real = flash_start[6+begin/2];
		d_imag = flash_start[7+begin/2];
	}
	else if(level == nlevel - 2)
	{
		a_real = flash_start[12+begin];
		a_imag = flash_start[13+begin];
		d_real = flash_start[14+begin];
		d_imag = flash_start[15+begin];

	}
	else if(level == nlevel - 3)
	{
		a_real = flash_start[28+begin*2];
		a_imag = flash_start[29+begin*2];
		d_real = flash_start[30+begin*2];
		d_imag = flash_start[31+begin*2];
	}

	PRINTF("----------------------------level = %f\n\r", level);
	DBFB(a_real, a_imag, x_real, x_imag, h_real, h_imag, size, 17, first, 0);
	DBFB(d_real, d_imag, x_real, x_imag, g_real, g_imag, size, 16, first, 1);



	float K1 = kurtosis(&a_real[16], &a_imag[16], (size/2)-16, 0);
	float K2 = kurtosis(&d_real[15], &d_imag[15], (size/2)-15, 0);
	PRINTF("k1 = %f\n\r", K1);
	PRINTF("k2 = %f\n\r", K2);

	if (level == 1)
	{
		K[nlevel][row_index_for_first_level] = K1;
		K[nlevel][row_index_for_first_level+1] = K2;
		row_index_for_first_level += 2;
	}

	if(level>1)
	{
		int copy = 1;
		for(int i = 0;i<level-1;i++)
		{
			copy = copy*2;
		}

		kurt_local(a_real, a_imag , size/2, level-1, begin, 0);
		kurt_local(d_real, d_imag , size/2, level-1, begin+copy, 0);




		for(int i=begin; i<begin+copy; i++)
		{
			K[nlevel-level+1][i] = K1;
		}
		for(int i=begin+copy; i<begin+2*copy; i++)
		{
			K[nlevel-level+1][i] = K2;
		}
	}

	if(level == nlevel)
	{
		K1 = kurtosis(x_real, x_imag, size, 1);

		for(int i=0;i<mocnina_dvou;i++)
		{
			K[0][i] = K1;
		}

	}
}


static FLASH_EraseInitTypeDef EraseInitStruct;
uint32_t Address_real = 0, PAGEError = 0, Address_imag = 0;

void DBFB(uint32_t *res_real, uint32_t *res_imag, uint32_t *x_real, uint32_t *x_imag, const float *f_real, const float *f_imag, int size, int size_filter, int first, int neg)
{
	int index_start = -size_filter+1, index_end = 0, i_s;
	int index_coef = 0;
	int index_array = 0;
	int save = 0;
	float result_real;
	float result_imag;
	float x_imag_temp, x_real_temp;

	//erase flash memory
	HAL_FLASH_Unlock();

	EraseInitStruct.TypeErase   = FLASH_TYPEERASE_PAGES;
	EraseInitStruct.PageAddress = res_real;
	EraseInitStruct.NbPages     = ((size*2) / FLASH_PAGE_SIZE)+1; // (size/2)*4 byte

	if (HAL_FLASHEx_Erase(&EraseInitStruct, &PAGEError) != HAL_OK)
	{
		PRINTF("flash error Erase real\n\r");
	}
	Address_real = res_real;

	EraseInitStruct.TypeErase   = FLASH_TYPEERASE_PAGES;
	EraseInitStruct.PageAddress = res_imag;
	EraseInitStruct.NbPages     = ((size*2) / FLASH_PAGE_SIZE)+1;

	if (HAL_FLASHEx_Erase(&EraseInitStruct, &PAGEError) != HAL_OK)
	{
		PRINTF("flash error Erase imag\n\r");
	}
	Address_imag = res_imag;
	while(index_end<size)
	{
		if(save == 1)
		{
			result_real = 0;
			result_imag = 0;
			index_coef = 0;

			if(index_start<0)
			{
				i_s = 0;
			}
			else
			{
				i_s = index_start;
			}
			for(int i=index_end;i>=i_s;i--)
			{
				if(first == 1)
				{
					x_imag_temp = 0;
				}
				else
				{
					x_imag_temp = UintToFloat(x_imag[i]);
				}
				x_real_temp = UintToFloat(x_real[i]);

				result_real += f_real[index_coef]*x_real_temp - f_imag[index_coef]*x_imag_temp;
				result_imag += f_real[index_coef]*x_imag_temp + f_imag[index_coef]*x_real_temp;
				index_coef++;
			}
			if(neg == 1 && ((index_array == 0)||index_array % 2 == 0))
			{
				result_real = -result_real;
				result_imag = -result_imag;
			}

			if (HAL_FLASH_Program(FLASH_TYPEPROGRAM_WORD, Address_real, FloatToUint(result_real)) == HAL_OK)
			{
				Address_real = Address_real + 4;
			}
			else
			{
				PRINTF("flash error program real\n\r");
			}

			if (HAL_FLASH_Program(FLASH_TYPEPROGRAM_WORD, Address_imag, FloatToUint(result_imag)) == HAL_OK)
			{
				Address_imag = Address_imag + 4;
			}
			else
			{
				PRINTF("flash error program imag\n\r");
			}

			//res_real[index_array] = FloatToUint(result_real);
			//res_imag[index_array] = FloatToUint(result_imag);
			index_array++;
			save = 0;
		}
		else if(save == 0)
		{
			save = 1;
		}

		index_start++;
		index_end++;
	}

	HAL_FLASH_Lock();
}



int index_i, index_j;
float index_m;
void maxK()
{
	int maxI, maxJ;
	float maxM = 0;
	for(int i = 0; i < nlevel+1; i++)
	{
		for(int j = 0; j < mocnina_dvou; j++)
		{
			if(K[i][j] > maxM)
			{
				maxM = K[i][j];
				maxI = i;
				maxJ = j;
			}
		}
	}
	index_i = maxI;
	index_j = maxJ;
	index_m = maxM;
}



